open Core
module Gf = Ntts_r_fun.Gf_z
module Ntt_sw = Ntts_r_fun.Ntt_sw.Make (Gf)

let%expect_test "form 2d input matrix, transpose" =
  let input = Array.init 16 ~f:(fun i -> Gf.of_z (Z.of_int i)) in
  let matrix = Ntt_sw.matrix input 2 2 in
  print_s [%message (matrix : Gf.t array array)];
  let transpose = Ntt_sw.transpose matrix in
  print_s [%message (transpose : Gf.t array array)];
  [%expect
    {|
    (matrix ((0 1 2 3) (4 5 6 7) (8 9 10 11) (12 13 14 15)))
    (transpose ((0 4 8 12) (1 5 9 13) (2 6 10 14) (3 7 11 15))) |}]
;;

let%expect_test "inverse, 4 step" =
  let input = Array.init 16 ~f:(fun i -> Gf.of_z (Z.of_int i)) in
  let expected = Array.copy input in
  Ntt_sw.inverse_dit expected;
  print_s [%message (expected : Gf.t array)];
  let four_step = Ntt_sw.four_step input 2 in
  print_s [%message (four_step : Gf.t array)];
  [%expect
    {|
    (expected
     (120 9185100786013534200 18444501065828136953 9189603281834309625
      18444492269600899065 9185082089752463353 2260596040923128
      9189586793186428920 18446744069414584313 9257157276228155385
      18444483473373661177 9261661979662120952 2251799813685240
      9257140787580274680 2243003586447352 9261643283401050105))
    (four_step
     (120 9185100786013534200 18444501065828136953 9189603281834309625
      18444492269600899065 9185082089752463353 2260596040923128
      9189586793186428920 18446744069414584313 9257157276228155385
      18444483473373661177 9261661979662120952 2251799813685240
      9257140787580274680 2243003586447352 9261643283401050105)) |}]
;;

(* hardware *)

open Hardcaml
open Hardcaml_waveterm
module N4 = Ntts_r_fun.Ntt_4step
module Gf_bits = Ntts_r_fun.Gf_bits.Make (Bits)
module Core = Ntts_r_fun.Ntt_4step.Core
module Sim = Cyclesim.With_interface (Core.I) (Core.O)

let logn = N4.logn
let logcores = N4.logcores

let%expect_test "" =
  let sim =
    Sim.create
      ~config:Cyclesim.Config.trace_all
      (Core.create (Scope.create ~flatten_design:true ()))
  in
  let inputs = Cyclesim.inputs sim in
  let waves, sim = Waveform.create sim in
  let input_coefs =
    Array.init (1 lsl logcores) ~f:(fun _ ->
        Array.init (1 lsl logn) ~f:(fun _ -> Z.of_int (Random.int 100_000)))
  in
  Cyclesim.cycle sim;
  inputs.wr_en := Bits.vdd;
  for core = 0 to (1 lsl logcores) - 1 do
    for ntt = 0 to (1 lsl logn) - 1 do
      inputs.wr_addr
        := Bits.( @: ) (Bits.of_int ~width:logcores core) (Bits.of_int ~width:logn ntt);
      inputs.wr_d := Gf_bits.of_z input_coefs.(core).(ntt) |> Gf_bits.to_bits;
      Cyclesim.cycle sim
    done
  done;
  inputs.wr_en := Bits.gnd;
  inputs.start := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.start := Bits.gnd;
  for _ = 0 to 1000 do
    Cyclesim.cycle sim
  done;
  Waveform.print ~display_width:94 ~display_height:76 ~wave_width:(-6) waves;
  (* XX aray: Why againt it raising *)
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────────┐
    │clock             ││╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥│
    │                  ││╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨│
    │clear             ││                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────│
    │rd_addr           ││ 00                                                                     │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │rd_en             ││                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │start             ││          ╥                                                             │
    │                  ││──────────╨─────────────────────────────────────────────────────────────│
    │                  ││╥╥╥╥╥╥╥╥╥╥╥─────────────────────────────────────────────────────────────│
    │wr_addr           ││║║║║║║║║║║║ 3F                                                          │
    │                  ││╨╨╨╨╨╨╨╨╨╨╨─────────────────────────────────────────────────────────────│
    │                  ││╥╥╥╥╥╥╥╥╥╥╥─────────────────────────────────────────────────────────────│
    │wr_d              ││║║║║║║║║║║║ 0000000000010A6E                                            │
    │                  ││╨╨╨╨╨╨╨╨╨╨╨─────────────────────────────────────────────────────────────│
    │wr_en             ││╥─────────╥                                                             │
    │                  ││╨         ╨─────────────────────────────────────────────────────────────│
    │done_             ││───────────┐                                                            │
    │                  ││           └────────────────────────────────────────────────────────────│
    │                  ││───────────╥╥─┬╥────────────────────────────────────────────────────────│
    │rd_q              ││ 000000000.║║ │║ 00000000000C44FD                                       │
    │                  ││───────────╨╨─┴╨────────────────────────────────────────────────────────│
    │START_CORES       ││          ╥                                                             │
    │                  ││──────────╨─────────────────────────────────────────────────────────────│
    │STATE             ││           ┌────────────────────────────────────────────────────────────│
    │                  ││───────────┘                                                            │
    │gnd               ││                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────│
    │input_ram         ││ 0000000000000000                                                       │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────│
    │input_ram_0       ││ 0000000000000000                                                       │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────│
    │input_ram_1       ││ 0000000000000000                                                       │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────│
    │input_ram_2       ││ 0000000000000000                                                       │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────│
    │output_ram        ││ 0000000000000000                                                       │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────│
    │output_ram_0      ││ 0000000000000000                                                       │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────│
    │output_ram_1      ││ 0000000000000000                                                       │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────│
    │output_ram_2      ││ 0000000000000000                                                       │
    │                  ││────────────────────────────────────────────────────────────────────────│
    │                  ││───────────╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥│
    │twiddle           ││ 000000000.║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║│
    │                  ││───────────╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨│
    │                  ││───────────╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥│
    │twiddle_0         ││ 000000000.║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║│
    │                  ││───────────╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨│
    │                  ││───────────╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥│
    │twiddle_1         ││ 000000000.║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║│
    │                  ││───────────╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨│
    │                  ││───────────╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥│
    │twiddle_2         ││ 000000000.║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║│
    │                  ││───────────╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨│
    │vdd               ││────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                        │
    │                  ││                                                                        │
    │                  ││                                                                        │
    │                  ││                                                                        │
    │                  ││                                                                        │
    │                  ││                                                                        │
    │                  ││                                                                        │
    └──────────────────┘└────────────────────────────────────────────────────────────────────────┘ |}]
;;
