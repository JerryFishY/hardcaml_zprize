open! Base
open Hardcaml
open Hardcaml_waveterm
module Ntt = Ntts_r_fun.Ntt.Controller
module Sim = Cyclesim.With_interface (Ntt.I) (Ntt.O)

let%expect_test "addressing" =
  let sim = Sim.create (Ntt.create (Scope.create ())) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  inputs.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clear := Bits.gnd;
  inputs.start := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.start := Bits.gnd;
  for _ = 0 to 14 do
    Cyclesim.cycle sim
  done;
  Waveform.print ~display_height:34 ~wave_width:1 ~display_width:90 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │clear             ││────┐                                                               │
    │                  ││    └───────────────────────────────────────────────────────────────│
    │start             ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │                  ││────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────│
    │addr1             ││ 0          │2  │4  │6  │0  │1  │4  │5  │0  │1  │2  │3  │0          │
    │                  ││────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────│
    │                  ││────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────│
    │addr2             ││ 0      │1  │3  │5  │7  │2  │3  │6  │7  │4  │5  │6  │7  │0          │
    │                  ││────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────│
    │done_             ││    ┌───┐                                               ┌───────────│
    │                  ││────┘   └───────────────────────────────────────────────┘           │
    │                  ││────────────────────────┬───────────────┬───────────────┬───────────│
    │i                 ││ 0                      │1              │2              │3          │
    │                  ││────────────────────────┴───────────────┴───────────────┴───────────│
    │                  ││────────────────────────────┬───┬───┬───┬───┬───┬───┬───┬───────────│
    │j                 ││ 0                          │1  │0  │1  │0  │1  │2  │3  │0          │
    │                  ││────────────────────────────┴───┴───┴───┴───┴───┴───┴───┴───────────│
    │                  ││────────────┬───┬───┬───┬───────┬───────┬───────────────────────────│
    │k                 ││ 0          │2  │4  │6  │0      │4      │0                          │
    │                  ││────────────┴───┴───┴───┴───────┴───────┴───────────────────────────│
    │                  ││────────┬───────────────┬───────────────┬───────────────┬───────────│
    │m                 ││ 0      │1              │2              │4              │0          │
    │                  ││────────┴───────────────┴───────────────┴───────────────┴───────────│
    │                  ││────────────────────────┬───────────────┬───────────────────────────│
    │omega             ││ FFFFFFFF00000000       │00010000000000.│FFFFFFFEFF000001           │
    │                  ││────────────────────────┴───────────────┴───────────────────────────│
    │start_twiddles    ││        ┌───────────────────┐   ┌───┐   ┌───┐           ┌───┐       │
    │                  ││────────┘                   └───┘   └───┘   └───────────┘   └───────│
    │                  ││                                                                    │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;
