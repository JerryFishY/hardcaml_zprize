open! Base
open Hardcaml
open Hardcaml_waveterm

let%expect_test "addressing" =
  let module Ntt = Ntts_r_fun.Ntt.Controller in
  let module Sim = Cyclesim.With_interface (Ntt.I) (Ntt.O) in
  let sim = Sim.create (Ntt.create (Scope.create ())) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  inputs.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clear := Bits.gnd;
  inputs.start := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.start := Bits.gnd;
  for _ = 0 to 14 do
    Cyclesim.cycle sim
  done;
  Waveform.print ~display_height:38 ~wave_width:1 ~display_width:90 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │clear             ││────┐                                                               │
    │                  ││    └───────────────────────────────────────────────────────────────│
    │start             ││    ┌───┐                                                           │
    │                  ││────┘   └───────────────────────────────────────────────────────────│
    │                  ││────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────│
    │addr1             ││ 0          │2  │4  │6  │0  │1  │4  │5  │0  │1  │2  │3  │0          │
    │                  ││────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────│
    │                  ││────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────│
    │addr2             ││ 0      │1  │3  │5  │7  │2  │3  │6  │7  │4  │5  │6  │7  │0          │
    │                  ││────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────│
    │done_             ││    ┌───┐                                               ┌───────────│
    │                  ││────┘   └───────────────────────────────────────────────┘           │
    │first_stage       ││        ┌───────────────┐                                           │
    │                  ││────────┘               └───────────────────────────────────────────│
    │                  ││────────────────────────┬───────────────┬───────────────┬───────────│
    │i                 ││ 0                      │1              │2              │3          │
    │                  ││────────────────────────┴───────────────┴───────────────┴───────────│
    │                  ││────────────────────────────┬───┬───┬───┬───┬───┬───┬───┬───────────│
    │j                 ││ 0                          │1  │0  │1  │0  │1  │2  │3  │0          │
    │                  ││────────────────────────────┴───┴───┴───┴───┴───┴───┴───┴───────────│
    │                  ││────────────┬───┬───┬───┬───────┬───────┬───────────────────────────│
    │k                 ││ 0          │2  │4  │6  │0      │4      │0                          │
    │                  ││────────────┴───┴───┴───┴───────┴───────┴───────────────────────────│
    │                  ││────────┬───────────────┬───────────────┬───────────────┬───────────│
    │m                 ││ 0      │1              │2              │4              │0          │
    │                  ││────────┴───────────────┴───────────────┴───────────────┴───────────│
    │                  ││────────────────────────┬───────────────┬───────────────────────────│
    │omega             ││ FFFFFFFF00000000       │00010000000000.│FFFFFFFEFF000001           │
    │                  ││────────────────────────┴───────────────┴───────────────────────────│
    │start_twiddles    ││        ┌───────────────────┐   ┌───┐   ┌───┐           ┌───┐       │
    │                  ││────────┘                   └───┘   └───┘   └───────────┘   └───────│
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "top" =
  let module Ntt = Ntts_r_fun.Ntt.Hardware in
  let module Gf = Ntts_r_fun.Gf.Make (Bits) in
  let module Sim = Cyclesim.With_interface (Ntt.I) (Ntt.O) in
  let sim = Sim.create ~config:Cyclesim.Config.trace_all (Ntt.create (Scope.create ())) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  let outputs = Cyclesim.outputs sim in
  inputs.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clear := Bits.gnd;
  inputs.start := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.start := Bits.gnd;
  let linear n =
    Array.init n ~f:(function
        | 0 -> Gf.one
        | 1 -> Gf.two
        | _ -> Gf.zero)
  in
  let coefs = linear 8 |> Array.map ~f:Gf.to_bits in
  let addr1_in = ref 0 in
  let addr2_in = ref 0 in
  for _ = 0 to 14 do
    inputs.d1 := coefs.(!addr1_in);
    inputs.d2 := coefs.(!addr2_in);
    addr1_in := Bits.to_int !(outputs.addr1_in);
    addr2_in := Bits.to_int !(outputs.addr2_in);
    Cyclesim.cycle sim;
    if Bits.to_bool !(outputs.write_enable_out)
    then (
      let addr1_out = Bits.to_int !(outputs.addr1_out) in
      let addr2_out = Bits.to_int !(outputs.addr2_out) in
      let q1 = !(outputs.q1) in
      let q2 = !(outputs.q2) in
      coefs.(addr1_out) <- q1;
      coefs.(addr2_out) <- q2)
  done;
  Waveform.print
    ~display_height:54
    ~wave_width:1
    ~display_width:90
    ~display_rules:
      [ Display_rule.port_name_matches
          Re.Posix.(compile (re ".*"))
          ~wave_format:Unsigned_int
      ]
    waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────┐
    │                  ││────┬───────────────────────────────────────────────────────────────│
    │clear             ││ 1  │0                                                              │
    │                  ││────┴───────────────────────────────────────────────────────────────│
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ │
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─│
    │                  ││────────┬───┬───────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────│
    │d1                ││ 0      │1  │2      │0  │2  │0  │11.│0  │18.│0  │26.│18.│44.│0      │
    │                  ││────────┴───┴───────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────│
    │                  ││────────┬───┬───────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────│
    │d2                ││ 0      │1  │0      │2  │18.│4  │18.│22.│8  │18.│18.│17.│18.│0      │
    │                  ││────────┴───┴───────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────│
    │                  ││────┬───┬───────────────────────────────────────────────────────────│
    │start             ││ 0  │1  │0                                                          │
    │                  ││────┴───┴───────────────────────────────────────────────────────────│
    │                  ││────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────│
    │addr1_in          ││ 0          │2  │1  │3  │0  │1  │4  │5  │0  │1  │2  │3  │0          │
    │                  ││────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────│
    │                  ││────────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────│
    │addr1_out         ││ 0              │2  │4  │6  │0  │1  │4  │5  │0  │1  │2  │3  │0      │
    │                  ││────────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────│
    │                  ││────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────────│
    │addr2_in          ││ 0      │4  │6  │5  │7  │2  │3  │6  │7  │4  │5  │6  │7  │0          │
    │                  ││────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────────│
    │                  ││────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────│
    │addr2_out         ││ 0          │1  │3  │5  │7  │2  │3  │6  │7  │4  │5  │6  │7  │0      │
    │                  ││────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────│
    │                  ││────────┬───┬───────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────│
    │q1                ││ 0      │1  │2          │0  │4  │11.│22.│22.│18.│45.│0  │32 │0      │
    │                  ││────────┴───┴───────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────│
    │                  ││────────┬───┬───────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───────│
    │q2                ││ 0      │1  │2      │18.│4  │18.│11.│18.│18.│16 │18.│18.│89.│0      │
    │                  ││────────┴───┴───────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───────│
    │                  ││────┬───┬───────────────────────────────────────────────┬───────────│
    │read_enable_in    ││ 1  │0  │1                                              │0          │
    │                  ││────┴───┴───────────────────────────────────────────────┴───────────│
    │                  ││────────────┬───────────────────────────────────────────────┬───────│
    │write_enable_out  ││ 0          │1                                              │0      │
    │                  ││────────────┴───────────────────────────────────────────────┴───────│
    │                  ││────────────────────────────────────────────────────────────────────│
    │gnd               ││ 0                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬───────────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───│
    │twiddle           ││ 0          │1                  │28.│1  │28.│1  │18.│28.│18.│1  │18.│
    │                  ││────────────┴───────────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───│
    │                  ││────────────────────────────────────────────────────────────────────│
    │vdd               ││ 1                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────│
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    │                  ││                                                                    │
    └──────────────────┘└────────────────────────────────────────────────────────────────────┘ |}]
;;
